---
import { toolSections } from "../data/toolSections";

const { activePage } = Astro.props;

// Helper function to check if a page matches an item URL
function isActiveItem(itemUrl: string, currentPage: string | undefined): boolean {
  if (!currentPage) return false;
  // Remove leading/trailing slashes for comparison
  const normalizedUrl = itemUrl.replace(/^\/|\/$/g, "");
  const normalizedPage = currentPage.replace(/^\/|\/$/g, "");
  return normalizedUrl === normalizedPage;
}

// Helper function to check if block should be open/active
function isBlockActive(items: any[], currentPage: string | undefined): boolean {
  if (!currentPage) return false;
  return items.some((item) => isActiveItem(item.url, currentPage));
}
---

<div id="sidebar">
  <div class="mask"></div>
  <div class="container">
    <header>
      <a href="/">
        <h2>Web Tools</h2>
      </a>
      <div class="toolbar">
        <div class="lang-dropdown">
          <button class="lang-btn" id="lang-btn" aria-haspopup="true" aria-expanded="false">
            <span class="lang-flag">ðŸ‡¬ðŸ‡§</span>
            <span class="lang-text">EN</span>
            <svg class="lang-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
          <div class="lang-menu" id="lang-menu" role="menu">
            <a href="/" class="lang-option active" role="menuitem">
              <span class="lang-flag">ðŸ‡¬ðŸ‡§</span>
              <span class="lang-name">English</span>
            </a>
            <a href="/vi/" class="lang-option" role="menuitem">
              <span class="lang-flag">ðŸ‡»ðŸ‡³</span>
              <span class="lang-name">Tiáº¿ng Viá»‡t</span>
            </a>
            <a href="/zh/" class="lang-option" role="menuitem">
              <span class="lang-flag">ðŸ‡¨ðŸ‡³</span>
              <span class="lang-name">ä¸­æ–‡</span>
            </a>
            <a href="/hi/" class="lang-option" role="menuitem">
              <span class="lang-flag">ðŸ‡®ðŸ‡³</span>
              <span class="lang-name">à¤¹à¤¿à¤‚à¤¦à¥€</span>
            </a>
            <a href="/es/" class="lang-option" role="menuitem">
              <span class="lang-flag">ðŸ‡ªðŸ‡¸</span>
              <span class="lang-name">EspaÃ±ol</span>
            </a>
            <a href="/fr/" class="lang-option" role="menuitem">
              <span class="lang-flag">ðŸ‡«ðŸ‡·</span>
              <span class="lang-name">FranÃ§ais</span>
            </a>
            <a href="/pt/" class="lang-option" role="menuitem">
              <span class="lang-flag">ðŸ‡µðŸ‡¹</span>
              <span class="lang-name">PortuguÃªs</span>
            </a>
            <a href="/ja/" class="lang-option" role="menuitem">
              <span class="lang-flag">ðŸ‡¯ðŸ‡µ</span>
              <span class="lang-name">æ—¥æœ¬èªž</span>
            </a>
          </div>
        </div>
        <button class="icon theme"><img class="light" src="/images/light.svg" alt="Dark mode" title="Dark mode" /><img class="dark" src="/images/dark.svg" alt="Dark mode" title="Dark mode" /></button>
      </div>
    </header>

    {
      toolSections.map((section) => (
        <div class="section">
          <h3>{section.title}</h3>
          {section.blocks.map((block) => (
            <details class={isBlockActive(block.items, activePage) ? "active" : ""} open={isBlockActive(block.items, activePage)}>
              <summary>{block.title}</summary>
              <nav>
                <ol>
                  {block.items.map((item) => (
                    <li class={isActiveItem(item.url, activePage) ? "active" : ""}>
                      <a href={`/${item.url}`}>{item.name}</a>
                    </li>
                  ))}
                </ol>
              </nav>
            </details>
          ))}
        </div>
      ))
    }
  </div>
</div>

<script is:inline>
  // Language Dropdown Toggle
  (function () {
    const langBtn = document.getElementById("lang-btn");
    const langMenu = document.getElementById("lang-menu");

    if (langBtn && langMenu) {
      langBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        const isExpanded = langBtn.getAttribute("aria-expanded") === "true";
        langBtn.setAttribute("aria-expanded", !isExpanded);
        langMenu.classList.toggle("show");
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (!langBtn.contains(e.target) && !langMenu.contains(e.target)) {
          langBtn.setAttribute("aria-expanded", "false");
          langMenu.classList.remove("show");
        }
      });

      // Close dropdown on Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          langBtn.setAttribute("aria-expanded", "false");
          langMenu.classList.remove("show");
        }
      });
    }
  })();
</script>
