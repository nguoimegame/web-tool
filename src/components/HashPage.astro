---
import BaseLayout from "../layouts/BaseLayout.astro";
import Sidebar from "../components/Sidebar.astro";
import PageHeader from "../components/PageHeader.astro";
import InputBlock from "../components/InputBlock.astro";
import OutputBlock from "../components/OutputBlock.astro";

interface Props {
  title: string;
  description: string;
  algorithmName: string;
  jsFile?: string;
  activePage: string;
  methodWrapper?: string;
}

const {
  title,
  description,
  algorithmName,
  jsFile = "crypto-js.js",
  activePage,
  methodWrapper,
} = Astro.props;

// Pre-calculate the script source path
const scriptSrc = jsFile.startsWith("http") ? jsFile : `/js/${jsFile}`;
const methodCode = methodWrapper || `window['${algorithmName}']`;
---

<BaseLayout title={`${title} - Web Tools`} description={description}>
  <div id="app">
    <Sidebar activePage={activePage} />
    <div id="content">
      <div class="top-nav">
        <button id="sidebar-toggler" aria-controls="sidebar" aria-expanded="false" aria-label="Menu">
          <img src="/images/menu.svg" width="24" height="24" alt="Menu" />
        </button>
      </div>
      <PageHeader title={title} description={description} />
      <main>
        <div class="layout">
          <div class="layout-block">
            <InputBlock
              id="input"
              title="Input"
              placeholder="Enter here..."
              dataRemember="input"
              dataShare="input"
              dataEncodingFrom="#input-type"
              dataAutoUpdate={true}
            />
            <OutputBlock
              id="output"
              title="Output"
              placeholder="Output here..."
              dataEncodingFrom="#output-type"
            />
          </div>
          <div class="settings">
            <div class="block block-fill">
              <div class="block-title">Settings</div>
              <div class="container">
                <div class="setting">
                  <a class="btn" id="execute">Hash</a>
                </div>
                <div class="setting">
                  <label class="switcher">
                    <input
                      type="checkbox"
                      value="1"
                      id="auto-update"
                      checked
                    />
                    <div class="toggle"></div>
                    <span>Auto Update</span>
                  </label>
                </div>
                <div class="setting">
                  <label class="switcher">
                    <input type="checkbox" value="1" id="remember-input" />
                    <div class="toggle"></div>
                    <span>Remember Input</span>
                  </label>
                </div>
                <div class="setting">
                  <label for="input-type">Input Encoding</label>
                  <select
                    data-toggle="encoding"
                    id="input-type"
                    data-remember="input-type"
                    data-share="input_type"
                    data-auto-update
                  >
                    <optgroup label="Binary">
                      <option value="hex">Hex</option>
                      <option value="base64" data-load-encoding="base64">
                        Base64
                      </option>
                    </optgroup>
                    <optgroup label="Text">
                      <option value="utf-8" selected>UTF-8</option>
                      <option value="utf-16le" data-load-encoding="1">
                        UTF-16LE
                      </option>
                      <option value="utf-16be" data-load-encoding="1">
                        UTF-16BE
                      </option>
                    </optgroup>
                  </select>
                </div>
                <div class="setting">
                  <label for="output-type">Output Encoding</label>
                  <select
                    data-toggle="encoding"
                    id="output-type"
                    data-remember="output-type"
                    data-share="output_type"
                    data-auto-update
                    data-type="hex"
                  >
                    <option value="hex">Hex (Lower Case)</option>
                    <option value="hex_upper">Hex (Upper Case)</option>
                    <option value="base64" data-load-encoding="base64">
                      Base64
                    </option>
                  </select>
                </div>
                <div class="setting">
                  <label class="switcher">
                    <input
                      type="checkbox"
                      value="1"
                      id="hmac-enabled"
                      data-remember="hmac-enabled"
                      data-share="hmac_enabled"
                      data-auto-update
                    />
                    <div class="toggle"></div>
                    <span>Enable HMAC</span>
                  </label>
                </div>
                <details class="setting-group" id="hmac" style="display:none" open>
                  <summary>HMAC</summary>
                  <div class="setting">
                    <label for="hmac-input-type">Encoding</label>
                    <select
                      data-toggle="encoding"
                      id="hmac-input-type"
                      data-remember="hmac-input-type"
                      data-share="hmac_input_type"
                      data-auto-update
                    >
                      <optgroup label="Binary">
                        <option value="hex">Hex</option>
                        <option value="base64" data-load-encoding="base64">
                          Base64
                        </option>
                      </optgroup>
                      <optgroup label="Text">
                        <option value="utf-8" selected>UTF-8</option>
                        <option value="utf-16le" data-load-encoding="1">
                          UTF-16LE
                        </option>
                        <option value="utf-16be" data-load-encoding="1">
                          UTF-16BE
                        </option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="setting">
                    <label for="hmac-key">Key</label>
                    <input
                      type="text"
                      id="hmac-key"
                      data-remember="hmac-key"
                      data-share="hmac_key"
                      data-encoding-from="#hmac-input-type"
                      data-auto-update
                    />
                  </div>
                </details>
                <script is:inline>
                  ++waitLoadCount;
                  delayScripts.push({
                    src: "/js/hmac.js?v=2",
                  });
                </script>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <div id="message"></div>
  </div>

  <!-- Hash Page Loader -->
  <script is:inline src="/js/hash-page-loader.js"></script>
  
  <script is:inline define:vars={{ scriptSrc, algorithmName, methodCode, methodWrapper }}>
    // Initialize hash page loader
    const loader = new HashPageLoader({
      scriptSrc,
      algorithmName,
      methodCode,
      methodWrapper
    });
    
    // Load all required scripts
    loader.loadScripts();
  </script>
</BaseLayout>
